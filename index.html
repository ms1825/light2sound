<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RGB Vocoder Receiver</title>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: monospace; text-align: center; }
        video { width: 100%; height: 60vh; object-fit: cover; }
        .guide { position: absolute; top: 30vh; left: 50%; transform: translateX(-50%); width: 80px; height: 80px; border: 4px solid white; z-index: 10; box-shadow: 0 0 15px rgba(255,255,255,0.5); }
        #bars { display: flex; justify-content: center; height: 100px; gap: 10px; margin-top: 20px; }
        .bar { width: 30px; background: #333; display: flex; align-items: flex-end; }
        .fill { width: 100%; background: grey; height: 0%; transition: height 0.05s; }
        button { font-size: 20px; padding: 15px; margin-top: 10px; background: #444; color: white; border: none; }
    </style>
</head>
<body>

    <div class="guide"></div>
    <video id="video" autoplay playsinline muted></video>

    <div id="bars">
        <div class="bar" style="border: 1px solid red;"><div id="r-fill" class="fill" style="background: red;"></div></div>
        <div class="bar" style="border: 1px solid green;"><div id="g-fill" class="fill" style="background: green;"></div></div>
        <div class="bar" style="border: 1px solid blue;"><div id="b-fill" class="fill" style="background: cyan;"></div></div>
    </div>

    <button id="startBtn">START DECODER</button>
    <div id="console"></div>

    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        const startBtn = document.getElementById('startBtn');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        
        let audioCtx;
        // We need 3 oscillators and 3 gain nodes
        const synths = {
            bass: { osc: null, gain: null, freq: 100 },  // Low Drone
            mid:  { osc: null, gain: null, freq: 500 },  // Voice range
            high: { osc: null, gain: null, freq: 2500 }  // Hiss/Static
        };

        startBtn.addEventListener('click', async () => {
            startBtn.style.display = 'none';
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();

            // Setup the 3 voices
            Object.keys(synths).forEach(key => {
                const s = synths[key];
                s.osc = audioCtx.createOscillator();
                s.gain = audioCtx.createGain();
                
                // Use Sawtooth for a buzzier, richer sound (better for vocoder feel)
                s.osc.type = 'sawtooth'; 
                s.osc.frequency.value = s.freq;
                s.gain.gain.value = 0;

                s.osc.connect(s.gain);
                s.gain.connect(audioCtx.destination);
                s.osc.start();
            });

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', frameRate: { ideal: 60 } }, audio: false
                });
                video.srcObject = stream;
                processFrame();
            } catch (e) {
                alert("Camera Error: " + e.message);
            }
        });

        function processFrame() {
            requestAnimationFrame(processFrame);
            if (video.readyState !== video.HAVE_ENOUGH_DATA) return;

            if (canvas.width !== video.videoWidth) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
            }

            ctx.drawImage(video, 0, 0);

            // Read center pixels
            const size = 40;
            const cx = (canvas.width / 2) - (size/2);
            const cy = (canvas.height / 2) - (size/2);
            const frame = ctx.getImageData(cx, cy, size, size).data;

            let rTotal = 0, gTotal = 0, bTotal = 0;
            let count = 0;

            for (let i = 0; i < frame.length; i += 16) {
                rTotal += frame[i];
                gTotal += frame[i+1];
                bTotal += frame[i+2];
                count++;
            }

            // Normalize (0.0 to 1.0)
            const r = (rTotal / count) / 255;
            const g = (gTotal / count) / 255;
            const b = (bTotal / count) / 255;

            // Visual feedback
            document.getElementById('r-fill').style.height = (r * 100) + "%";
            document.getElementById('g-fill').style.height = (g * 100) + "%";
            document.getElementById('b-fill').style.height = (b * 100) + "%";

            // Audio Mixing (Noise Gate at 0.1 to stop humming when dark)
            const now = audioCtx.currentTime;
            const ramp = 0.05; // Smooth transitions

            synths.bass.gain.gain.setTargetAtTime(r > 0.1 ? r : 0, now, ramp);
            synths.mid.gain.gain.setTargetAtTime(g > 0.1 ? g : 0, now, ramp);
            synths.high.gain.gain.setTargetAtTime(b > 0.1 ? b * 0.5 : 0, now, ramp); // Highs are piercing, so lower volume
        }
    </script>
</body>
</html>

